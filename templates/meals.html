{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-utensils"></i> Add Meal</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_meal') }}">
                    <div class="mb-3">
                        <label for="meal_type" class="form-label">Meal Type</label>
                        <select class="form-control" name="meal_type" required>
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="food_items" class="form-label">Food Items</label>
                        <textarea class="form-control" id="food_items" name="food_items" rows="3" placeholder="Enter food items..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="calories" class="form-label">Calories</label>
                            <input type="number" step="0.1" class="form-control" id="calories" name="calories" placeholder="Total calories">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="protein_g" class="form-label">Protein (g)</label>
                            <input type="number" step="0.1" class="form-control" id="protein_g" name="protein_g" placeholder="Protein in grams">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="carbs_g" class="form-label">Carbs (g)</label>
                            <input type="number" step="0.1" class="form-control" id="carbs_g" name="carbs_g" placeholder="Carbs in grams">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fats_g" class="form-label">Fats (g)</label>
                            <input type="number" step="0.1" class="form-control" id="fats_g" name="fats_g" placeholder="Fats in grams">
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">Add Meal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Recent Meals</h5>
            </div>
            <div class="card-body">
                {% for meal in user_meals %}
                <div class="mb-2 p-2 bg-light rounded">
                    <strong>{{ meal.meal_type }}</strong> - {{ meal.date }}
                    <br><small>{{ meal.food_items }}</small>
                    {% if meal.calories %}
                    <span class="badge bg-primary float-end">{{ "%.0f"|format(meal.calories) }} cal</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<script>
let debounceTimer;

document.getElementById('food_items').addEventListener('input', function() {
    const query = this.value.trim();
    
    if (query.length < 3) return;
    
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        fetchNutritionData(query);
    }, 1000);
});

function fetchNutritionData(query) {
    fetch('/get_nutrition', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({query: query})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }
        
        document.getElementById('calories').value = Math.round(data.calories);
        document.getElementById('protein_g').value = data.protein.toFixed(1);
        document.getElementById('carbs_g').value = data.carbs.toFixed(1);
        document.getElementById('fats_g').value = data.fat.toFixed(1);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}